---
# tasks file for letsbuilda.server.bootstrap

- name: Create groups
  group:
    name: "{{ group }}"
    state: present
  loop: "{{ user_groups }}"
  loop_control:
    loop_var: group

- name: Create users
  user:
    name: "{{ user.name }}"
    group: "{{ user.name }}"
    groups: "{{ user.groups }}"
    password: "{{ user.password | password_hash }}"
    shell: "{{ user.shell }}"
  loop: "{{ users }}"
  loop_control:
    loop_var: user

- name: Create each user's ssh directory
  file:
    path: "/home/{{ user.name }}/.ssh"
    state: directory
    mode: 0700
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
  loop: "{{ users }}"
  loop_control:
    loop_var: user

- name: Create the authorized_keys file for each user
  blockinfile:
    path: "/home/{{ user.name }}/.ssh/authorized_keys"
    marker: ""
    block: |
      "{{ user.ssh_key }}"
    mode: 0600
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
  loop: "{{ users }}"
  loop_control:
    loop_var: user
